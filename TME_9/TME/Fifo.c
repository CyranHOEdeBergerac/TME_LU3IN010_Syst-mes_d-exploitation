#include "Fifo.h"

#include <unistd.h>
#include <stdlib.h>
#include <stdio.h>

int initFifo(Swapper*);
unsigned int fifoChoose(Swapper*);
void fifoReference(Swapper*,unsigned int frame);
void finalizeFifo(Swapper*);

int initFifoSwapper(Swapper*swap,unsigned int frames){
	return	initSwapper(swap,frames,initFifo,NULL,fifoChoose,finalizeFifo);
}

void printUseFIFO(Swapper*swap){
	int i, ind;
	FIFO * fifo = (FIFO*)swap->private_data;
	fprintf(stderr,"État de la file :\t");
	if (fifo->tete == -1){
		fprintf(stderr,"Vide !\n");
		return;
	}
	for (i = 0; i< swap->frame_nb;i++){
		ind = (fifo->tete + i)%swap->frame_nb; 
		fprintf(stderr,"%d\t",fifo->file[ind]);
		if (ind + 1 %swap->frame_nb == fifo->queue){
			break;				//On est arrivé à la queue
		}
	}
	fprintf(stderr,"\n");
}


int initFifo(Swapper*swap){
	/* A ecrire en TME */
	swap->private_data = malloc(sizeof(FIFO));
	if (swap->private_data==NULL){
		return 1;			//Erreur d'allocation
	}
	FIFO* fifo = (FIFO*) swap->private_data;
	fifo->tete = -1;	// Début du tableau
	fifo->queue = 0;	//Première case où on fera un ajout
	fifo->file = (int*)malloc(swap->frame_nb*sizeof(int));	//File
	if (fifo->file== NULL){
		return 1;			//Erreur d'allocation
	}
	return 0;
}

unsigned int fifoChoose(Swapper*swap){
	/* A ecrire en TME */
	int i, frame = -1;
	FIFO* fifo = (FIFO*)swap->private_data;
	/*On cherche des cases libres*/
	for (i= 0; i< swap->frame_nb; i++){
		if (swap->frame[i]==-1){
			frame = i;		//Il y a une case libre
			if (fifo->tete == -1){	//Premier ajout
				fifo->tete = frame;
			}
			fifo->file[fifo->queue] = frame;
			fifo->queue = (fifo->queue + 1)%swap->frame_nb;		//indice du prochain ajout dans la file
			break;
		}
	}
	if (frame == -1){
		/*On a pas trouvé de place libre, il va falloir faire un swap*/
		frame = fifo->file[fifo->tete];	//On retire en tête
		fifo->tete = (fifo->tete + 1) % swap->frame_nb;			//Indice de la tête après le retrait
		fifo->file[fifo->queue] = frame;					//On remet la frame choisie à la fin de la file
		fifo->queue = (fifo->queue + 1)%swap->frame_nb;		//indice du prochain ajout dans la file
	}

	DEBUG(
		fprintf(stderr,"FIFO uses: ");
		printUseFIFO(swap);
		fprintf(stderr,"\n\n");
	);
	return frame;
}

void finalizeFifo(Swapper*swap){
	/* A ecrire en TME */
	FIFO* fifo = (FIFO*)swap->private_data;
	free(fifo->file);
	free(fifo);
}
