#include "LRU.h"

#include <unistd.h>
#include <stdlib.h>
#include <stdio.h>

int	initLRU(Swapper*);
void	referenceLRU(Swapper*,unsigned int frame);
unsigned int chooseLRU(Swapper*);
void	finalizeLRU(Swapper*);


 

typedef struct {
	unsigned int clock;
	unsigned int * age;
} InfoLRU;

int initLRUSwapper(Swapper*swap,unsigned int frames){
 return	initSwapper(swap,frames,initLRU,referenceLRU,chooseLRU,finalizeLRU);
}

int	initLRU(Swapper*swap){
	/* A ecrire en TME */
	swap->private_data = calloc(swap->frame_nb,sizeof(int));
	int * tps = (int*)swap->private_data;
	int i;
	/* Initialisation du tableau */
	for( i=0 ; i<swap->frame_nb ; i++ )
		tps[i] = 0;
	return 0;
}

void referenceLRU(Swapper*swap,unsigned int frame){
	int i;
	int * tps = (int*)swap->private_data;
	/* A chaque acces, le temps depuis la dernière utilisation d'une case augmente */
	for (i = 0; i< swap->frame_nb ; i++)
		tps[i]++; 
	tps[frame] = 0;		//Le temps depuis la dernière utilisation de la frame choisie est alors de 0.
}

unsigned int chooseLRU(Swapper*swap){
	int i, frame = 0;
	int * tps = swap->private_data;
	/* Choisir la case (contenant une page)  ayant le compteur le plus grand (plus longtemps depuis la dernière utilisation) */
	for ( i=0 ; i<swap->frame_nb ; i++ ){
		if( swap->frame[i] == -1 ){
			frame = i;			//Frame libre !
			for (i = frame +1 ; i < swap->frame_nb ; i++){
				tps[i]++;
			}
								//
			break;
		}
		if( tps[i] > tps[frame] )
			frame = i;
		tps[i]++;			//On augmente le temps pour tout le monde
	}
	tps[frame] = 0;			//Le temps depuis la dernière utilisation de la frame est de 0.
	DEBUG(
		fprintf(stderr,"LRU uses: ");
		printUse(swap);
		fprintf(stderr,"\n\n");
	);
	
	return frame;
	
}

void	finalizeLRU(Swapper*swap){
	free(swap->private_data);
}
