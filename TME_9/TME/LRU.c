#include "LRU.h"

#include <unistd.h>
#include <stdlib.h>
#include <stdio.h>

int	initLRU(Swapper*);
void	referenceLRU(Swapper*,unsigned int frame);
unsigned int chooseLRU(Swapper*);
void	finalizeLRU(Swapper*);


typedef struct {
	unsigned int clock;
	unsigned int * age;
} InfoLRU;



int initLRUSwapper(Swapper*swap,unsigned int frames){
 return	initSwapper(swap,frames,initLRU,referenceLRU,chooseLRU,finalizeLRU);
}


void printUseLRU(Swapper* swap){
	int i;
	InfoLRU* infos = swap->private_data;
	printf("Temps courant : %d\n",infos->clock);
	for (i = 0; i< swap->frame_nb; i++){
		printf("%d\t",infos->age[i]);
	}
	printf("\n");
}


int	initLRU(Swapper*swap){
	int i;
	swap->private_data = malloc(sizeof(InfoLRU));
	if (swap->private_data == NULL){
		return 1;
	}
	InfoLRU* infos = (InfoLRU*) swap->private_data;
	infos->clock = 0;
	infos->age = (unsigned int*) malloc(swap->frame_nb* sizeof(unsigned int));
	for (i = 0; i < swap->frame_nb ; i++){
		infos->age[i] = 0;
	}
	return 0;
}


void referenceLRU(Swapper*swap,unsigned int frame){
	InfoLRU* infos = (InfoLRU*) swap->private_data;
	infos->clock ++;
	infos->age[frame] = infos->clock;
}

unsigned int chooseLRU(Swapper*swap){
	int i, frame = 0;
	InfoLRU * infos = swap->private_data;
	/* Choisir la case (contenant une page)  ayant le compteur le plus petit */
	
	for ( i=0 ; i<swap->frame_nb ; i++ ){
		if( swap->frame[i] == -1 ){
			frame = i;
			break;
		}
		if( infos->age[i] < infos->age[frame] )
			frame = i;
	}
	infos->clock++;
	infos->age[frame] = infos->clock;

	DEBUG(
		fprintf(stderr,"LFU uses: ");
		printUseLRU(swap);
		fprintf(stderr,"\n\n");
	);
	
	return frame;
}

void	finalizeLRU(Swapper*swap){
	InfoLRU * infos = (InfoLRU*) swap->private_data;
	free(infos->age);
	free(swap->private_data);
}
